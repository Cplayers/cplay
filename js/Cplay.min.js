!function(){var jsmediatags=window.jsmediatags,imgPath="./img/",contentInner="./img/contentInner.png",cplay=window.Cplay={author:"nigehaotinga",audio:new Audio("./resource/livetune,初音ミク - Tell Your World.mp3"),detail:{artist:"初音ミク",title:"Tell Your World",album:"Tell Your World EP",picture:contentInner},lyrics:[{time:"[00:04.000]",data:"作词 : kz"},{time:"[00:06.000]",data:"作曲 : kz"},{time:"[00:08.000]",data:""},{time:"[00:25.600]",data:"形のない気持ち忘れないように"},{time:"[00:31.000]",data:"決まりきったレイアウトを消した"},{time:"[00:38.000]",data:"ふと口ずさんだフレーズを掴まえて"},{time:"[00:16.000]",data:"胸に秘めた言葉乗せ空に解き放つの"},{time:"[00:20.000]",data:"君に伝えたいことが"},{time:"[00:22.000]",data:"君に届けたいことが"},{time:"[00:24.000]",data:"たくさんの点は線になって"},{time:"[00:26.000]",data:"遠く彼方へと響く"},{time:"[00:28.000]",data:"君に伝えたい言葉"},{time:"[00:30.000]",data:"君に届けたい音が"},{time:"[00:32.000]",data:"いくつもの線は円になって"},{time:"[00:34.000]",data:"全て繋げてく　どこにだって Ah..."},{time:"[00:36.000]",data:""},{time:"[00:38.000]",data:"真っ白に澄んだ光は君のよう"},{time:"[00:40.000]",data:"かざした手の隙間を伝う声が"},{time:"[00:42.000]",data:"ふと動いた指先刻むリズムに"},{time:"[00:44.000]",data:"ありったけの言葉乗せ空に解き放つの"},{time:"[00:48.000]",data:"君に伝えたいことが"},{time:"[00:50.000]",data:"君に届けたいことが"},{time:"[00:52.000]",data:"たくさんの点は線になって"},{time:"[00:54.000]",data:"遠く彼方まで穿（うが）つ"},{time:"[00:56.000]",data:"君に伝えたい言葉"},{time:"[00:58.000]",data:"君に届けたい音が"},{time:"[01:00.000]",data:"いくつもの線は円になって"},{time:"[01:02.000]",data:"全て繋げてく　どこにだって Ah..."},{time:"[01:04.000]",data:""},{time:"[01:06.000]",data:"奏でていた 変わらない日々を疑わずに"},{time:"[01:08.000]",data:"朝は誰かがくれるものだと思ってた"},{time:"[01:10.000]",data:"一瞬でも信じた音　景色を揺らすの"},{time:"[01:12.000]",data:"教えてよ　君だけの世界"},{time:"[01:16.000]",data:"君が伝えたいことは"},{time:"[01:18.000]",data:"君が届けたいことは"},{time:"[01:20.000]",data:"たくさんの点は線になって"},{time:"[01:22.000]",data:"遠く彼方へと響く"},{time:"[01:24.000]",data:"君が伝えたい言葉"},{time:"[01:26.000]",data:"君が届けたい音は"},{time:"[01:28.000]",data:"いくつもの線は円になって"},{time:"[01:34.000]",data:"全て繋げてく　どこにだって Ah..."}],isEdited:!1,isPlayed:!1,isDrag:!1,index:0,duration:257,create:function(callback,options){this.options={sad:options.sad||300,volume:options.volume||.39,audioRate:options.audioRate||1},this.audio.volume=this.options.volume,pageInit(this),pagePlayerCtrl(classEs.play,this),pageVolumeCtrl(classEs.volumebtn,this),pageProgressBar(this),pageLyricsEdit(),pageEditShortcuts(),pageCopyLyrics(this),settingBox(),this.isEnd(),pageFileUp(classEs.uploading,classEs.uploadingFile,classEs.uploadbtn,callback)},change:function(musicfile,lyricsfile){let url=URL.createObjectURL(musicfile);return this.audio?this.audio.src=url:this.audio=new Audio(url),addEve(this.audio,"durationchange",(function(){cplay.duration=this.duration,cplay.isPlayed=!this.paused,this.volume=cplay.options.volume,this.audioRate=cplay.audioRate,getMusicInfo(musicfile,data=>{cplay.detail=data.content,formatLyrics(lyricsfile,data=>{cplay.lyrics=data.content,pageInit(cplay)})})})),this},playPause:function(){let promise;return cplay.isPlayed?(promise=cplay.audio.pause(),classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","paused")):(promise=cplay.audio.play(),classEs.play.style.setProperty("background-image","url(./img/play.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","running")),cplay.isPlayed=!cplay.isPlayed,promise},getCurrentTime:function(){return numberToFixed(this.audio.currentTime)},getProcess(callback){addEve(this.audio,"timeupdate",(function(){callback(this.currentTime/this.duration)}))},setVolume:function(v){v<=0?v=0:v>1&&(v=1),this.audio.volume=this.options.volume=1*numberToFixed(1*v,2),classEs.volumebtn.style.setProperty("width",100*v+"%")},skip:function(offset){offset<=0?offset=0:offset>1&&(offset=1),this.audio.currentTime=offset*this.audio.duration,classEs.ctt.style.setProperty("width",this.getCurrentTime()/this.audio.duration*100+"%"),setLyricsIndex(this.getCurrentTime()),lyricsScroll(this.index,!1)},isEnd:function(){addEve(this.audio,"ended",(function(){cplay.index=0,classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.detail.picture.style.setProperty("animation-play-state","paused")}))},getLyrics(index){return this.lyrics[index]},getLyricsTime(index){return formatToSeconds(this.lyrics[index].time)},setLyricsTime(index,time){this.lyrics[index].time=time},setLyricsContent(index,lyrics){this.lyrics[index].data=lyrics}};function formatToSeconds(time,flag=!0){var times="[00:00.000]";return 60*(times=flag?time.slice(1,time.length-1).split(":"):time.split(":"))[0]+1*times[1]}function secondsToFormat(time,flag=!0,number=3){var minute=Math.floor(time/60),second=numberToFixed(time%60,number);return second>59&&(minute+=1,second=numberToFixed(0,number)),minute=minute<10?"0"+minute:minute,second=second<10?"0"+second:second,flag?`[${minute}:${second}]`:`${minute}:${second}`}function numberToFixed(data,number=3){return data.toFixed(number)}function getMusicInfo(file,callback){jsmediatags.read(file,{onSuccess:function(tag){var picture;if(tag.tags.picture){for(var imageData=tag.tags.picture.data,base64String="",i=0;i<imageData.length;i++)base64String+=String.fromCharCode(imageData[i]);picture="data:"+tag.tags.picture.format+";base64,"+window.btoa(base64String)}callback({flag:!0,content:{artist:tag.tags.artist||"未知",title:tag.tags.title||"未知",album:tag.tags.album||"未知",picture:picture||contentInner}})},onError:function(error){console.log(error)}})}function formatLyrics(file,callback){let lyrics=[],reader=new FileReader;null==file&&callback({flag:!1,content:"error"}),reader.readAsText(file,"utf8"),reader.onload=()=>{let data,arrdata;reader.result.replace(/(\r\n|\r)/g,"\n").split("\n").reduce((pre,cur)=>(""==pre&&pre==cur||lyrics.push({time:"[00:00.000]",data:cur}),cur),void 0),callback({flag:!0,content:lyrics})}}var classEs={detail:{artist:getEle("cplay-artist"),title:getEle("cplay-title"),album:getEle("cplay-album"),picture:getEle("cplay-cover-img")},lyLi:getEles("cplay-lyrics"),lytime:getEles("cplay-lytime"),lyrics:getEle("cplay-lyrics-list"),editime:getEle("cplay-editime"),play:getEle("cplay-play"),volumebtn:getEle("cplay-volume-btn"),volume:getEle("cplay-volume"),uploading:getEle("cplay-uploading"),edit:getEle("cplay-edit"),save:getEle("cplay-save"),overview:getEle("cplay-overview"),copy:getEle("cplay-copy"),current:getEle("cplay-current"),ctt:getEle("cplay-ctt"),duration:getEle("cplay-duration"),uploadingFile:getEle("cplay-upload-file"),uploadbtn:getEle("cplay-upload"),bgi:getEle("cplay-bgi"),hintbox:getEle("cplay-hintbox"),setting:getEle("cplay-setting"),settingbox:getEle("cplay-settingbox")};function addEve(media,eventName,callback,flag=!1){media.addEventListener(eventName,callback,flag)}function removeEve(media,eventName,functionName){media.removeEventListener(eventName,functionName)}function getEle(classE){return document.querySelector(`.${classE}`)}function getEles(classE){return document.querySelectorAll(`.${classE}`)}function pageInit(data){imagSwitch(data.detail.picture,(function(src){classEs.detail.picture.src=src,classEs.bgi.style.setProperty("background-image",`url(${src})`)})),classEs.detail.title.innerHTML=data.detail.title,classEs.detail.artist.innerHTML=data.detail.artist,classEs.detail.picture.style.setProperty("animation-play-state","paused"),data.isPlayed=!1,data.isEdited=!1,data.isDrag=!1,data.index=0,classEs.lyrics=classEs.lyrics||getEle("cplay-lyrics-list"),classEs.lyrics.innerHTML="";for(let lyLi of data.lyrics)classEs.lyrics.innerHTML+=`<li index='${data.index++}' class="lr-li cplay-lyrics"><span class='cplay-lytime' contenteditable>${lyLi.time}</span>${lyLi.data}</li>`;data.index=0,classEs.play.style.setProperty("background-image","url(./img/pause.svg)"),classEs.volumebtn.style.setProperty("width",100*data.options.volume+"%"),classEs.current.innerHTML="00:00",classEs.duration.innerHTML=secondsToFormat(data.duration,!1,0),classEs.ctt.style.setProperty("width","0%"),lyricsEdit()}function pagePlayerCtrl(p,c){addEve(p,"click",(function(){playerCtrl(c)}))}function playerCtrl(c){c.playPause()}function pageVolumeCtrl(vbtn,c){addEve(classEs.volume,"click",(function(){getEle("m-vol").style.setProperty("display","block")})),addEve(getEle("m-vol"),"mouseleave",(function(){getEle("m-vol").style.setProperty("display","none")})),addEve(getEle("vbg"),"click",(function(event){let leftVal=vbtn.getBoundingClientRect().left,barWidth=getEle("vbg").getBoundingClientRect().width,barleft=event.clientX-leftVal;cplay.setVolume(barleft/barWidth)})),getEle("cplay-volume-btn .btn").onmousedown=function(){let leftVal=vbtn.getBoundingClientRect().left,barWidth=getEle("vbg").getBoundingClientRect().width;document.onmouseup=null,document.onmousemove=function(event){let barleft=event.clientX-leftVal;cplay.setVolume(barleft/barWidth),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()},document.onmouseup=function(){document.onmousemove=null}}}function pageProgressBar(c){c.getProcess((function(percent){c.isDrag||(classEs.current.innerHTML=secondsToFormat(c.getCurrentTime(),!1,0),classEs.ctt.style.setProperty("width",100*percent+"%")),c.isEdited||pageLyricsScroll(1*c.getCurrentTime(),c)})),addEve(getEle("barbg"),"click",(function(event){let leftVal=classEs.ctt.getBoundingClientRect().left,barWidth=getEle("barbg").getBoundingClientRect().width,barleft=event.clientX-leftVal;cplay.skip(barleft/barWidth)})),getEle("cplay-ctt .btn").onmousedown=function(){let leftVal=classEs.ctt.getBoundingClientRect().left,barWidth=getEle("barbg").getBoundingClientRect().width;document.onmouseup=null,document.onmousemove=function(event){cplay.isDrag=!0;let barleft,offset=(event.clientX-leftVal)/barWidth;offset<=0?offset=0:offset>1&&(offset=1),classEs.ctt.style.setProperty("width",100*offset+"%"),classEs.current.innerHTML=secondsToFormat(offset*c.audio.duration,!1,0),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()},document.onmouseup=function(event){if(cplay.isDrag=!1,document.onmousemove){let barleft=event.clientX-leftVal;cplay.skip(barleft/barWidth)}document.onmousemove=null}}}function pageLyricsScroll(currentime,c){c.index>=c.lyrics.length||(-1==c.index||c.getLyricsTime(c.index)<=currentime)&&(lyricsScroll(c.index),c.index++)}function lyricsScroll(index,flag=!0,ha=100){for(const li of getEles("cplay-lyrics"))li.classList.remove("active");-1==index?cplay.index=index=0:getEles("cplay-lyrics")[index].classList.add("active");let top,clientheight,height=getEles("cplay-lyrics")[index].offsetTop-classEs.lyrics.clientHeight/2+ha;flag?animate({duration:cplay.options.sad,timing:function(timeFraction){return-timeFraction*timeFraction+2*timeFraction},draw:function(progress){classEs.lyrics.scroll(0,height-39*(1-progress))}}):classEs.lyrics.scroll(0,height)}function setLyricsIndex(currentime){let orgtime;if(currentime<cplay.getLyricsTime(0))cplay.index=-1;else for(let i=0;i<cplay.lyrics.length;i++){if(i==cplay.lyrics.length-1)return void(cplay.index=i);if(cplay.getLyricsTime(i)<=currentime&&currentime<=cplay.getLyricsTime(i+1))return void(cplay.index=i)}}function pageLyricsEdit(){addEve(classEs.edit,"click",lyricsEdit),pageLyricsView()}function lyricsEdit(){cplay.isEdited=!0,classEs.lyrics.onclick=null,cplay.isEdited&&(hintBox(hints.edit),pageEditShortcuts(),classEs.lyrics.onclick=function(e){if(e.target.children[0]){var ele=e.target.children[0];let index=e.target.getAttribute("index");ele.style.setProperty("display","inline-block"),document.onkeydown=null,e.target.onmouseleave=function(){lyricsSave(this.children[0],index),pageEditShortcuts()}}})}function pageLyricsView(){addEve(classEs.overview,"click",lyricsView)}function lyricsView(){if(cplay.isEdited=!1,!cplay.isEdited){hintBox(hints.view),classEs.lyrics.onclick=null;for(const lyLi of getEles("cplay-lyrics"))lyLi.onmouseleave=null;document.onkeydown=null,pageShortcuts(cplay),setLyricsIndex(cplay.getCurrentTime())}}function lyricsSave(ele,index){return/^\[[0-9]{2}:[0-9]{2}\.[0-9]{3}\]$/.test(ele.innerText)?(cplay.setLyricsTime(index,ele.innerText),ele.style.setProperty("display","none"),!0):(alert("时间轴格式不对，请修改后保存"),!1)}function pageFileUp(uploading,upFiles,uploadbtn,callback){addEve(uploading,"click",(function(){upFiles.style.setProperty("display","block")})),addEve(uploadbtn,"click",(function(){let musicFile=document.querySelector("#music-file"),lyricsFile=document.querySelector("#lyrics-file");if(musicFile=checkFile(musicFile),lyricsFile=checkFile(lyricsFile),!musicFile.flag||!lyricsFile.flag)return console.log("上传失败"),!1;callback(musicFile.content,lyricsFile.content)})),addEve(getEle("close"),"click",(function(){upFiles.style.setProperty("display","none");for(const ele of getEles("uploadfile"))ele.style.setProperty("background-image","url(./img/uploadfile.svg)")}));for(const ele of getEles("file input"))addEve(ele,"change",(function(){let file=checkFile(this);file.flag||alert(file.content)}))}function checkFile(file){return file.files[0]?(imagSwitch("./img/success.svg",(function(src){getEle(`${file.name} .uploadfile`).style.setProperty("background-image",`url(${src})`)})),{flag:!0,content:file.files[0]}):{flag:!1,content:"请上传文件"}}function pageShortcuts(c){document.onkeydown=function(event){var event;switch((event=event||window.event).key.toLowerCase()){case" ":playerCtrl(c)}}}function pageEditShortcuts(){document.onkeydown=function(event){var event;switch((event=event||window.event).key.toLowerCase()){case"enter":if(cplay.index<cplay.lyrics.length){let time=cplay.getCurrentTime();getEles("cplay-lyrics")[cplay.index].children[0].innerHTML=secondsToFormat(time,!0),lyricsSave(getEles("cplay-lyrics")[cplay.index].children[0],cplay.index),lyricsScroll(cplay.index),cplay.index++}break;case"q":if(cplay.index>1){cplay.index=cplay.index-2;let bftime=formatToSeconds(cplay.lyrics[cplay.index].time),offset=bftime/cplay.duration;cplay.skip(offset),classEs.ctt.style.setProperty("width",100*offset+"%"),classEs.current.innerHTML=secondsToFormat(bftime,!1,0),cplay.index++}else if(1==cplay.index){let bftime=formatToSeconds("[00:00.000]");cplay.skip(0),classEs.ctt.style.setProperty("width","0%"),classEs.current.innerHTML=secondsToFormat(bftime,!1,0)}break;case"enter":break;case" ":playerCtrl(cplay)}}}function pageCopyLyrics(c){addEve(classEs.copy,"click",(function(){let contents="";for(const ly of c.lyrics)contents+=`${ly.time}${ly.data}\n`;copyTxt(contents)}))}function copyTxt(text){if("function"!=typeof document.execCommand)return void console.log("歌词复制失败");var dom=document.createElement("textarea");dom.value=text,dom.setAttribute("style","display: block;width: 1px;height: 1px;"),document.body.appendChild(dom),dom.select();var result=document.execCommand("copy");if(document.body.removeChild(dom),result)return void hintBox(hints.copy);if("function"!=typeof document.createRange)return void console.log("歌词复制失败");var range=document.createRange(),div=document.createElement("div");div.innerHTML=text,div.setAttribute("style","height: 1px;fontSize: 1px;overflow: hidden;"),document.body.appendChild(div),range.selectNode(div);const selection=window.getSelection();selection.rangeCount>0&&selection.removeAllRanges(),selection.addRange(range),document.execCommand("copy"),hintBox(hints.copy)}function hintBox(content){classEs.hintbox.innerHTML=content,animate({duration:1e3,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.hintbox.style.setProperty("transform",`translate(-50%, ${50-150*progress}%)`),classEs.hintbox.style.setProperty("opacity",1-progress)}})}var hints={edit:"编辑模式",view:"预览模式",copy:"复制成功"};function settingBox(){addEve(classEs.setting,"click",(function(){animate({duration:300,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.settingbox.style.setProperty("transform",`translate(${150*progress-150}%, 0%)`)}})})),addEve(classEs.settingbox,"mouseleave",(function(){animate({duration:200,timing:function(timeFraction){return timeFraction*timeFraction},draw:function(progress){classEs.settingbox.style.setProperty("transform",`translate(${-150*progress}%, 0%)`)}})}))}function imagSwitch(src,callback){let img=new Image;img.src=src,img.onload=function(){callback(this.src)}}function bounce(timeFraction){for(let a=0,b=1,result;;a+=b,b/=2)if(timeFraction>=(7-4*a)/11)return-Math.pow((11-6*a-11*timeFraction)/4,2)+Math.pow(b,2)}function makeEaseOut(timing){return function(timeFraction){return 1-timing(1-timeFraction)}}function animate({timing:timing,draw:draw,duration:duration}){let start=performance.now();requestAnimationFrame((function animate(time){let timeFraction=(time-start)/duration;timeFraction>1&&(timeFraction=1);let progress=timing(timeFraction);draw(progress),timeFraction<1&&requestAnimationFrame(animate)}))}}();